# Apache setup quickref

This document was made specificly for Arch Linux, but I'm pretty sure it will work similarly with most Linux  
distributions, adapting the package manager, maybe package name...

### Install the apache package
```bash
sudo pacman -Sy && sudo pacman -S apache --noconfirm
```  
#### VirtualHost file    
```bash
/etc/httpd/conf/extra/httpd-vhost.conf
```  
Have to uncomment **Include conf/extra/httpd-vhosts.conf** in  
**/etc/httpd/conf/httpd.conf**
#### Virtualhost example - HTTP
```bash
<VirtualHost *:9999>
    <Directory "/home/gurgui/github/opoweb">
        AllowOverride None
        Require all granted
    </Directory>
    Options Indexes FollowSymLinks
    
    ServerName opoweb.com
    DocumentRoot "/home/gurgui/github/opoweb"         
    
    ErrorLog "/home/gurgui/github/opoweb/apache_error.log"
    CustomLog "/home/gurgui/github/opoweb/apache_access.log" common
    
    LoadModule php_module modules/libphp.so
    AddType "application/x-httpd-php" "php"
</VirtualHost>
```
| Keyword | Description | Possible Values |
|---|---|---|
| **Options** | Sets file system access controls and features for a directory. | Indexes, FollowSymLinks, MultiViews, Includes, ExecCGI, ... |
| **ServerName** | Specifies the hostname or IP address for a virtual host. | Domain name (e.g., example.com), IP address |
| **DocumentRoot** | Defines the directory containing the website files served by a virtual host. | Path to a directory (e.g., /var/www/html) |
| **CustomLog** | Specifies the location and format for access logs. | File path, log format (e.g., combined, common) |
| **ErrorLog** | Specifies the location for error logs generated by Apache. | File path |
| **Require** | Controls access to resources based on conditions. | all granted, user user1, ip 192.168.1.0/24, ... |
| **AllowOverride** | Determines which directives can be overridden in `.htaccess` files. | None, All, Options, FileInfo, AuthConfig, Limit, ... |  
| **Listen** | Determines an address/port that apache can use to listen, *=0.0.0.0 | *:80, 127.0.0.1:9001, 192.168.1.44:8888 ...| 
| **LoadModule** | Loads certain module on the VHost | "<module_name> modules/<module_lib_name>" |
| **AddType** | Adds a supported MIME type | 


Notes:
- When 'combined' is used in a CustomLog directive, access, agent and referer information will be in the same log file   

## Permissions
Make sure that rather the http user or group has access to the DocumentRoot and files within it. Also just give write permissions whenever the server is supposed to require it.  

## < Enable SSL >
### Uncomment the following 2 lines located in **/etc/httpd/conf/httpd.conf**
```bash
LoadModule ssl_module modules/mod_ssl
```
```bash
Include conf/extra/httpd-ssl.conf
```
This will:
- Enable SSL capabilities to our server.  
- Add a default configuration file for SSL **/etc/httpd/conf/extra/httpd-ssl.conf**. Both can be edited with the uncommented line above.  
Notes:  
- The default SSL configuration, in my case, required another module to be enabled, I had to also uncomment the following:  
```bash
LoadModule socache_shmcb_module modules/mod_socache_shmcb.so
``` 
### VirtualHost example (HTTPS)  
```bash
<VirtualHost *:443>
    <Directory "/home/gurgui/github/opoweb">
        AllowOverride None
        Require all granted
    </Directory>
    
    Options Indexes
    ServerName opoweb.com
    DocumentRoot "/home/gurgui/github/opoweb"         
    ErrorLog "/home/gurgui/github/opoweb/apache_error.log"

    SSLEngine on
    SSLCertificateFile "/etc/ssl/certs/opoweb_SV-crt.pem"
    SSLCertificateKeyFile "/etc/ssl/private/opoweb_SV-key.pem"
</VirtualHost>
```  
| Keyword | Description | Possible Values |
|---|---|---|  
| **SSLEngine** | enable/disable SSL| on,off|
| **SSLCertificateFile** | indicates where the server certificate is located | string (path)  
| **SSLCertificateKeyFile** | indicates where the server key is located | string (path)

### Create self-signed server key/certificate  
I used my own disgrace [gpkih](https://github.com/Gurguii/gpkih) to build them:  
```bash
gpkih init -n foo -s ~/foo -noprompt &&\
gpkih set foo @pki.key size=2048 algorithm=rsa &&\
gpkih build foo ca -cn opoweb_CA -n &&\
gpkih build foo sv -cn opoweb_SV -y &&\
gpkih list foo -f key,crt
```  
Then just copy the ***SERVER*** (not ***CA***) certificate and key to whatever path used  
### Restart the apache service so it loads the SSL module
```bash
sudo systemctl restart httpd
```  
## < Enable PHP >
### Install required files
```bash
sudo pacman -S php-apache
```  
This command will install:  
| File | Description |
|---|---|
| usr/lib/httpd/modules/libphp.so | shared library required to have php working
| etc/httpd/conf/extra/php_module.conf | configures the php module

### Add the following line to apache configuration file, /etc/httpd/conf/httpd.conf
```bash
LoadModule php_module modules/libphp.so
```
* This will make apache enable such library upon restart

### Add the following line to /etc/httpd/conf/mime.types  
```bash
application/x-httpd-php php
```  
* This will make apache appropiately associate the .php extensions with the header.

### Restart the apache service so it loads the PHP module
```bash
sudo systemctl restart httpd
```  

## IMPORTANT
**LoadModule** and **AddType** directives can be added within <VirtualHost> tags to enable certain modules and extensions for such VHOST as shown in the example above.